{
    "collab_server" : "",
    "contents" : "R\nlibrary(ggplot2)\nlibrary(lubridate)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(data.table)\nmytheme <- theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), panel.grid.major.y = element_blank())# element_line(colour=\"grey60\", linetype=\"dashed\"))\nmytheme <- mytheme + theme(text=element_text(size=18)) + theme(axis.title.x=element_text(size=22) ,axis.title.y=element_text(size=22))\nmytheme <- mytheme + theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank() )\nmytheme <- mytheme + theme( panel.background = element_rect(fill=\"white\"), panel.border = element_rect(colour=\"black\", fill=NA, size=1))\nq()\nn\nsetwd(\"~/Onedrive/ebswp/data/sampler/cases/ebswp\")\nsetwd(\"~/Onedrive/sampler/cases/ebswp\")\n# source sampler.R\nsource(\"../../sampleR/R/sampler.R\")\n#--------------------------\n# Fishery data pull and write files for sampler\n#--------------------------\nSampler(yr=2016,est=FALSE)\nfor (i in 1991:2016) Sampler(yr=i,est=FALSE)\nadt <- data.table(Get_Age(1991)); adt$yr <- 1991\nfor (i in 1992:2016) {\n  tmp <- data.table(Get_Age(i)); tmp$yr <- i\n  adt <- rbind(adt,tmp)\n}\nadt\nldt <- data.table(Get_LF(1991)); ldt$yr <- 1991\nfor (i in 1992:2016) {\n  tmp <- data.table(Get_LF(i)); tmp$yr <- i\n  ldt <- rbind(ldt,tmp)\n}\nsetkey(adt,yr)\nsetkey(ldt,yr)\nnames(adt)\nadt[age>0,.(nhauls=max(haul),.N),yr]\nadt[,.(max(haul),.N),yr]\nldt[order(yr),.(hauls=max(haul),freq=sum(freq)),yr]\nldt[yr<2017,.(max(haul),sum(freq)),yr]\nldt[yr<2017,.(max(haul),sum(freq,na.rm=TRUE)),yr]\naldt <- cbind( adt[age>0,.(N_haul_ages=max(haul,na.rm=TRUE ),N_ages=.N),yr], ldt[yr<2016,.(N_haul_lengths=max(haul),N_lengths=sum(freq)/20),yr])\nnames(aldt) <- c(\"yr\",\"N_haul_ages\",\"N_ages\",\"yr2\",  \"N_haul_lengths\",\"N_lengths\"     )\nnames(aldt)\naldt\nal <- data.table(melt(aldt, measure.vars = c(2,3,5,6), variable.name = \"measure\", value.name = \"N\"))\nis.factor(al$measure)\nggplot(al,aes(x=yr,y=N,colour=measure,shape=measure)) +  geom_point() + geom_line() + mytheme + xlab(\"Year\") + ggtitle(\"Fishery samples\")+\nscale_colour_discrete(labels=c(\"Number of age-hauls \", \"Number of ages\", \"Number of length-hauls\",\"Number of lengths / 20\")) +\nscale_shape_discrete(labels=c(\"Number of age-hauls \", \"Number of ages\", \"Number of length-hauls\",\"Number of lengths / 20\")) + guides(guide_legend(title=NULL))\n\nal\nal[,\nggplot(al,aes(x=yr,y=N,colour=measure,shape=measure)) +  geom_point() + geom_line() + mytheme + xlab(\"Year\") + ggtitle(\"Fishery samples\")+\nscale_colour_discrete(labels=c(\"Number of age-hauls \", \"Number of ages\", \"Number of length-hauls\",\"Number of lengths / 20\")) +\nscale_shape_discrete(labels=c(\"Number of age-hauls \", \"Number of ages\", \"Number of length-hauls\",\"Number of lengths / 20\")) + guides(guide_legend(title=NULL))\n\n\n#--------------------------\nSetBS(n=1)    #No bootstraps\nSetBS(n=1000) #1000 bootstraps\nread.table(\"bs_setup.dat\")\nfor (i in 1991:2016) Sampler(yr=i)\n#--------------------------\n# For survey look see file ebs_survey.R\n\n#--------------------------\n# Look at tally of lengths etc\ni=1991\ndt <- data.table(read.table(paste0(\"results/LF_\",i,\".rep\"),header=TRUE) )\nfor (i in 1992:2015) \n{\n  dt <- rbind(dt,    data.table(read.table(paste0(\"results/LF_\",i,\".rep\"),header=TRUE) ) )\n}\n#Sample sizes by year\ndt[,.(nlen=sum(nlen_samples), nwt=sum(nwt_samples),nage=sum(naged)),.(year,stratum)]\nq#--------------------------\n# Compare Weights\n#--------------------------\n# read in last year's values\nlywt <- as.data.frame(read.table(\"wtage2015.dat\",header=FALSE))\nmnwt <- as.data.frame(read.table(\"wtage2016.dat\",header=FALSE))\n\nwrite.table(as.data.frame(mnwt)[,2:14],file=\"ttt.dat\")\nnames(lywt) <- 3:15;lywt$yr <- yr; lywt$ayr=\"2015\"\nmnwt <- res\nmnwt$ayr=\"2016\"\n#names(mnwt) <- read.table(\"hdr.dat\",as.is=TRUE,header=FALSE);mnwt$yr <- yr; mnwt$ayr=\"2016\"\ndtmp <- data.table(rbind(mnwt,lywt))\ndtmp\nres <- data.table(melt(dtmp, measure.vars = 2:14, variable.name = \"age\", value.name = \"wt\"))\nres \nres[as.numeric(age)==4&yr==2014]\nstr(res)\nres[as.numeric(age)<10] %>% ggplot(aes(x=yr,y=wt,colour=as.factor(ayr))) + geom_line() + facet_grid(age~.,scales=\"free_y\") + \n     ylab(\"Average weight (kg)\") +  expand_limits(y=0) +mytheme+ labs(x=\"Year\",colour=\"Assessment \\n year\") + scale_y_continuous(breaks=c(0.5,1.0,1.5)) #scale_colour_discrete(guide=FALSE) \n\nyr = 1991:2014\n#--------------------------\n# Fishery wts\n#--------------------------\ni=1991\nwadt <- data.table(read.table(paste0(\"mainresults/wtage\",i,\".rep\"),header=TRUE) )\nnames(wadt) <- c(\"bs\",\"sam\",\"yr\",1:15)\nfor (i in 1992:2015) \n{\n  wadt <- rbind(wadt,data.table(read.table(paste0(\"mainresults/wtage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\nwadt.m <- melt(wadt, measure.vars = 4:18, variable.name = \"age\", value.name = \"wt\")\nwadt.m$age <-as.numeric(wadt.m$age )\ndtmp <- wadt.m[,.(bs,yr,wt,mnwt=mean(wt)),.(age)] #%>% mutate(bs,wt,mnwt,swt=wt/mnwt)\ndtmp <- dtmp[,.(yr,bs,age,wt,mnwt,swt=wt/mnwt)] #%>% mutate(bs,wt,mnwt,swt=wt/mnwt)\ndtmp\nfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- dtmp[yr %between% c(i-4,i)&age>2&age<11] %>% ggplot(aes(x=as.factor(age),y=swt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~.) + xlab(\"Age\") + ylab(\"Body weight relative to mean\") + \n       mytheme + theme(panel.grid.major.y = element_line(colour=\"grey\",linetype=\"dashed\",size=0.5) )\n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(limits=c(0.7,1.3),breaks=c(0.75,1.0,1.25))\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\nnames(wadt.m)\nwadt.m\n# Long to wide\nres <- dcast(wadt.m[,.(mean(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nres <- dcast(wadt.m[age>2,.(mean(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nres\nwrite.table(res, file=\"mnwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mdnwt.dat\")\nres <- dcast(wadt.m[,.(sd(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"sdwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwadt.m[,.(mean(wt)),.(yr,age),]\ndcast(wadt.m, yr ~ age, wt=value.var = \"wt\")\n#---------------------\n# Survey weights\n#---------------------\ni=1982\ni=1982\nwadt <- data.table(read.table(paste0(\"results/wtagesrv_\",i,\".rep\"),header=TRUE) )\nnames(wadt) <- c(\"bs\",\"sam\",\"yr\",1:15)\nfor (i in 1983:2015) \n{\n  wadt <- rbind(wadt,data.table(read.table(paste0(\"results/wtagesrv_\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\nwadt.m <- melt(wadt, measure.vars = 4:18, variable.name = \"age\", value.name = \"wt\")\nsubstr(wadt.m$yr,5,8) \nstr(wadt.m)\nwadt.m$age <-as.numeric(wadt.m$age )\nwadt.m$yr <-as.numeric(substr(wadt.m$yr,5,8) )\ni=2015\nfor (i in c(1985,1990,1995,2000,2005,2010 ,2015))\n{\n  p <- wadt.m[yr %between% c(i-4,i)&age>2&age<11] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~.) + xlab(\"Age\") + geom_point(data=rwadt.m,aes(x=as.factor(age),y=wt)) + mytheme \n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(limits=c(0,1.6),breaks=c(0.5,1.0,1.5))\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\nnames(wadt.m)\nwadt.m\n# Long to wide\nres <- dcast(wadt.m[,.(mean(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mnwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mdnwt.dat\")\nres <- dcast(wadt.m[,.(sd(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"sdwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwadt.m[,.(mean(wt)),.(yr,age),]\ndcast(wadt.m, yr ~ age, wt=value.var = \"wt\")\n#-------------------------------------------------\n# Stratified weights\n#-------------------------------------------------\ni=1991\nswadt <- data.table(read.table(paste0(\"mainresults/str_wtage\",i,\".rep\"),header=TRUE) )\nnames(swadt) <- c(\"bs\",\"sam\",\"yr\",\"str\",1:15)\nfor (i in 1992:2015) \n{\n  swadt <- rbind(swadt,data.table(read.table(paste0(\"mainresults/str_wtage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\n# Set strata labels\n(swadt$str[swadt$str==1]=\"A-season\")\n(swadt$str[swadt$str==2]=\"B-season, NW\")\n(swadt$str[swadt$str==3]=\"B-season, SE\")\n(swadt$str[swadt$str==999]=\"Combined\")\nstr(swadt)\nswadt.m <- melt(swadt, measure.vars = 5:19, variable.name = \"age\", value.name = \"wt\")\nswadt.m$age <-as.numeric(swadt.m$age )\nmytheme <- mytheme + theme(panel.grid.major.y = element_line(colour=\"grey\",linetype=\"dashed\"))\n#dt1 <- swadt.m[str==\"Combined\",.(bs,str,yr,wt,mnwt=mean(wt)),.(age)] \n#dt2 <- swadt.m[str!=\"Combined\",.(mnwt=mean(wt)),.(age)]\ndt1 <- swadt.m[str==\"Combined\",.(mnwt=mean(wt)),.(age)] \ndt2 <- swadt.m[,.(age,bs,str,yr,wt)] \nsetkey(dt2,age)\nsetkey(dt1,age)\ndtmp <- merge(dt1,dt2)\ndt2 <- swadt.m[.(bs,str,yr,wt,mnwt=mean(wt)),.(age)] #%>% mutate(bs,wt,mnwt,swt=wt/mnwt)\ndtmp <- dtmp[,.(yr,str,bs,age,wt,mnwt,swt=wt/mnwt)] #%>% mutate(bs,wt,mnwt,swt=wt/mnwt)\ndtmp\ni=2010\nfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- dtmp[yr %between% c(i-4,i)&age>2&age<11&str!=999] %>% ggplot(aes(x=as.factor(age),y=swt,fill=as.factor(yr-age))) \n  #p <- swadt.m[yr %between% c(i-4,i)&age>2&age<11&str!=999] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~str) + xlab(\"Age\") + mytheme + \n       ylab(\"Body weight relative to mean\")\n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + \n  scale_y_continuous(limits=c(0.6,1.6),breaks=c(0.7,1.0,1.3))\n  print(p)\n  # ylab(\"Average weight (kg)\")\n  #scale_y_continuous(limits=c(0,1.6),breaks=c(0.5,1.0,1.5))\n  #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n}\n\n\n#--------------------------\n# Now process results in a nice way...\n\ni=2015\nadt <- data.table(read.table(paste0(\"data/age\",i,\".dat\"),header=FALSE) )\nnames(adt) <- c(\"str\",\"haul\",\"sex\",\"age\",\"wt\",\"len\")\nsetkey(adt,age)\nadt[(age>0&wt>0),.(N=.N,mean=mean(wt),sd=sd(wt)),age] %>% filter(N>6) %>% transmute(age,N,mean,cv=sd/mean)\n\ni=1991\ncadt <- data.table(read.table(paste0(\"mainresults/catage\",i,\".rep\"),header=TRUE) )\nnames(cadt) <- c(\"bs\",\"sam\",\"yr\",1:15)\nfor (i in 1992:2015) \n{\n  cadt <- rbind(cadt,data.table(read.table(paste0(\"mainresults/catage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\ncadt\n# wide to long\ncadt.m <- melt(cadt, measure.vars = 4:18, variable.name = \"age\", value.name = \"catch\")\ncadt.m$age <-as.numeric(cadt.m$age )\ncadt.m\nt1 <- cadt.m[,.(catch,age,sc=sum(catch)),.(yr)][,.(yr,p=catch/sc,age),yr][,.(v=sum(age*age*p)-(sum(age*p)^2)),yr]\nt2 <- cbind(t1,cadt.m[,.(sa=sum(age*catch),sc=sum(catch)),.(bs,yr)][,.(yr,avg_age=mean(sa/sc),v_age=var(sa/sc)),yr])\nt2[,.(yr,avg_age,cv_avg_age=v_age^.5/avg_age,EffN=v/v_age)]\nbfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- cadt.m[yr %between% c(i-4,i)&age>2&age<10] %>% ggplot(aes(x=as.factor(age),y=catch,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~.) + xlab(\"Age\") + mytheme + ylim(0,1200000) + ylab(\"Catch in numbers\")\n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(breaks=NULL)\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\n\n\ngetwd()\n\n# Stratified catch at age\ni=1991\nscadt <- data.table(read.table(paste0(\"mainresults/str_catage\",i,\".rep\"),header=TRUE) )\n\nnames(scadt) <- c(\"bs\",\"sam\",\"yr\",\"str\",1:15)\nfor (i in 1992:2015) \n{\n  scadt <- rbind(scadt,data.table(read.table(paste0(\"mainresults/str_catage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\n# Set strata labels\n(scadt$str[scadt$str==1]=\"A-season\")\n(scadt$str[scadt$str==2]=\"B-season, NW\")\n(scadt$str[scadt$str==3]=\"B-season, SE\")\n# (scadt$str[scadt$str==999]=\"Combined\")\nstr(scadt)\nscadt.m <- melt(scadt, measure.vars = 5:19, variable.name = \"age\", value.name = \"wt\")\nscadt.m$age <-as.numeric(scadt.m$age )\nscadt.m[bs==1,.(wt,N=.N,p=wt/sum(wt),catch=sum(wt)),.(yr,str)]\nmytheme <- mytheme + theme(panel.grid.major.y = element_line(colour=\"grey\",linetype=\"dashed\"))\nscadt.m\nfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- scadt.m[yr %between% c(i-4,i)&age>2&age<11&str!=999] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~str) + xlab(\"Age\") + mytheme + ylab(\"Catch in numbers\")\n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(limits=c(0,5e5),breaks=c(0.20e6,.4e6))\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\n\n\ni=1991\nwadt <- data.table(read.table(paste0(\"results/wtage\",i,\".rep\"),header=TRUE) )\nnames(wadt) <- c(\"bs\",\"sam\",\"yr\",1:15)\nfor (i in 1992:2015) \n{\n  wadt <- rbind(wadt,data.table(read.table(paste0(\"results/wtage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\nwadt.m <- melt(wadt, measure.vars = 4:18, variable.name = \"age\", value.name = \"wt\")\nwadt.m$age <-as.numeric(wadt.m$age )\nfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- wadt.m[yr %between% c(i-4,i)&age>2&age<11] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~.) + xlab(\"Age\") + mytheme \n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(limits=c(0,1.6),breaks=c(0.5,1.0,1.5))\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\nnames(wadt.m)\nwadt.m\n# Long to wide\nres <- dcast(wadt.m[,.(mean(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mnwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mdnwt.dat\")\nres <- dcast(wadt.m[,.(sd(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"sdwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwadt.m[,.(mean(wt)),.(yr,age),]\ndcast(wadt.m, yr ~ age, wt=value.var = \"wt\")\n# Stratified weights\ni=1991\nswadt <- data.table(read.table(paste0(\"results/str_wtage\",i,\".rep\"),header=TRUE) )\nnames(swadt) <- c(\"bs\",\"sam\",\"yr\",\"str\",1:15)\nfor (i in 1992:2015) \n{\n  swadt <- rbind(swadt,data.table(read.table(paste0(\"results/str_wtage\",i,\".rep\"),header=TRUE)) ,use.names=FALSE)\n}\n# wide to long\n# Set strata labels\n(swadt$str[swadt$str==1]=\"A-season\")\n(swadt$str[swadt$str==2]=\"B-season, NW\")\n(swadt$str[swadt$str==3]=\"B-season, SE\")\n(swadt$str[swadt$str==999]=\"Combined\")\nstr(swadt)\nswadt.m <- melt(swadt, measure.vars = 5:19, variable.name = \"age\", value.name = \"wt\")\nswadt.m$age <-as.numeric(swadt.m$age )\nmytheme <- mytheme + theme(panel.grid.major.y = element_line(colour=\"grey\",linetype=\"dashed\"))\nfor (i in c(1995,2000,2005,2010 ,2015))\n{\n  p <- swadt.m[yr %between% c(i-4,i)&age>2&age<11&str!=999] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_violin() + facet_grid(yr~str) + xlab(\"Age\") + mytheme + ylab(\"Average weight (kg)\")\n  p <- p + scale_fill_discrete(guide=FALSE) + scale_fill_identity() + scale_y_continuous(limits=c(0,1.6),breaks=c(0.5,1.0,1.5))\n #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\n  print(p)\n}\n\n\nedf <- read.table(\"results/t.dat\",header=T)\nedf %>% filter(type=select(year, age))\nnames(edf)\ntbl_df(cd)\n\ncd <- (read.csv(paste(\"imported/akfincat.csv\",sep=\"\"),as.is=T,header=F))\nhdr_cat <- read.csv(\"imported/hdr_cat.csv\",as.is=T,header=F)\nnames(cd) <- hdr_cat\ncd <- data.table(cd)\ncd[FMP.Subarea==\"BS\",sum(wt_recorded),.(Year)]\n\ncdf <- cd %>% filter(FMP.Area==\"BSAI\",Species.Group.Name==\"Pollock\") %>%\n  transmute(\n    area=Reporting.Area.Code,month=trunc(WED/100),\n    strata=ifelse(month<6,1,ifelse(area>519,2,3)), \n    catch=wt_recorded\n  )  %>% select(strata, catch) %>%\n  group_by(strata) %>% summarise(catch=sum(catch))\ntbl_df(cdf)\ncdf$catch/sum(cdf$catch )\n#----Catch age variance-----------------------\ncdf <- read.table(\"catage_all_str.csv\",header=T)\ncdf <- read.table(\"catage_all.csv\",header=F)\ncdf <- data.frame(cdf)\nnames(cdf) <- c(\"yr\",\"sim\",1:15)\n# set Plus group 10+\ncdf[,12] <- \nrowsum(cdf[,12:17])\n?rowsum\ntbl_df(cdf)\ntdf <- gather(cdf,Age,catch,3:17) %>% filter(as.integer(Age)>2,as.integer(Age)<11) %>% transmute(yr,sim,Age,catch,cohort=as.factor(yr-as.integer(Age)))\ntdf$yr <- factor(tdf$yr,levels=c(seq(from=1991,to=2011,by=5),seq(from=1992,to=2012,by=5),seq(from=1993,to=2013,by=5),seq(from=1994,to=2014,by=5),seq(from=1995,to=2015,by=5)))\ntbl_df(tdf)\np <- ggplot(tdf,aes(x=Age,y=catch,fill=cohort)) #,group=Strata))\np <- p + geom_violin(aes(colour=cohort),width=1.1) + scale_colour_identity() + scale_fill_identity() #scale_fill_brewer(palette=\"Pastel2\") # + scale_colour_manual(palette-\"Pastel2\") #scale_fill_discrete()\np <- p + facet_wrap(~yr) + mytheme\np\n\np <- p + coord_flip()\np <- p + geom_line(aes(x=as.integer(age),y=(value),col=case))\np <- p + geom_bar(aes(x=(age),y=(value),col=case))\n\ngetwd()\nruns <- c(\"runs\",\"runs05\",\"runs10\",\"runs50\",\"runs99\")\nfor (j in 4:4){\n  system(\"rm Est*.dat\")\n  for (i in 10:23){\n  \tccc <- paste(\"cut -f \",i, \" data/\",runs[j],\".dat >sam.dat;./sam\",sep=\"\")\n  \tprint(ccc)\n\t  system(ccc)\n  }\n  system(paste(\"cat Est*.dat > \",runs[j],\"_est.rep\",sep=\"\"))\n}\n\nnames(df0)\ndf0  <- cbind(case=\"base\",read.table(\"runs_est.rep\",header=T))\ndf05 <- cbind(case=\"5% to A\",read.table(\"runs05_est.rep\",header=T))\ndf10 <- cbind(case=\"10% to A\",read.table(\"runs10_est.rep\",header=T))\ndf50 <- cbind(case=\"50% to A\",read.table(\"runs50_est.rep\",header=T))\ndf99 <- cbind(case=\"99% to A\",read.table(\"runs99_est.rep\",header=T))\nmdf  <- rbind(df0,df05,df10,df50,df99)\nreshape(mdf,idvar=case,direction=\"wide\")\n?aggregate\n\n# \"year\"    \"type\"    \"stratum\" \"sex\"     \"age\"     \"value\"  \ndf <- mdf %>% filter(type==\"N\") %>% filter(sex==99) %>% \n              filter(stratum==99) %>% filter(age<11)\np <- ggplot(df,aes(x=(age),y=value,col=case))\np <- p + geom_bar(aes(position=\"dodge\",col=case))\np <- p + geom_line(aes(x=(age),y=(value),col=case))\np <- p + geom_bar(aes(x=(age),y=(value),col=case))\n\np <- p + facet_wrap(~year)\nprint(p)\nsummary(df )\n\n#---------------------------------------\n#---------------------------------------\n# set up simulations\n# read in real data\nldf <- data.table(read.table(\"data/lensim.dat\",as.is=TRUE))\nnames(ldf)<-c(\"str\",\"haul\",\"sex\",\"len\",\"frq\")\nlength(ldf$haul)\nldf$haul <-  as.integer(1+ldf$haul/130)\nmax(ldf$haul)\nmin(ldf$haul)\n\nadf <- data.table(read.table(\"data/agesim.dat\",as.is=TRUE))\nnames(adf)<-c(\"str\",\"haul\",\"sex\",\"age\",\"wt\",\"len\")\nmax(adf$haul)\nadf$haul <-  as.integer(1+adf$haul/28)\nadf$haul <-  as.integer(1+adf$haul/1.03)\nsetkey(adf,len)\n# Sets up wt given length to means (\"recycled\")\nt<- adf[,.(str,haul,sex,age,mwt=mean(wt),len),len]\nadf[,.(mwt=mean(wt),len),len]\nt<- t[,.(str,haul,sex,age,mwt,len)]\nwrite.table(t,file=\"data/t.dat\",row.names=FALSE, col.names=FALSE)\ngetwd()\n?write.table\nplot(adf[,(len,wt=mean(wt))])\n#---------------------------------------\n\nlfdt <- data.table(read.table(paste0(\"results/LF_\",i,\".rep\"),header=TRUE) )\nfor (i in 1992:2015) \n{\n  lfdt <- rbind(lfdt,data.table(read.table(paste0(\"results/LF_\",i,\".rep\"),header=TRUE)) )\n}\n",
    "created" : 1502431195872.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2666964976",
    "id" : "FB57606F",
    "lastKnownWriteTime" : 1502431772,
    "last_content_update" : 1502431922679,
    "path" : "~/OneDrive/sampler/cases/ebswp/EBS_sampler.R",
    "project_path" : "EBS_sampler.R",
    "properties" : {
        "marks" : "<:48,157\n>:48,158"
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}