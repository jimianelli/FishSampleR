{
    "collab_server" : "",
    "contents" : "\n#--------------------------\n# Survey pull and convert\n#--------------------------\n# Filled in individual body weights using wt-lengths\n# MALEB 3.038 FEMALEB 2.986 TOTALB  2.9954  \nlwb <- c(3.038, 2.986,  2.9954)\nlwa <- c(0.000004919, 0.000006681,  6.3611E-06)\n\nsrvlen <- data.table(read.csv(\"~/OneDrive/ebswp/data/Survey/bts/Length_Survey_pollock.csv\"))\n\nsrvlen$yr <- substr(srvlen$CRUISE,1,4)\nsrvage$a <- lwa[srvage$SEX]\nsrvage$b <- lwb[srvage$SEX]\nnames(srvlen)\nnames(srvage)\ni=1993\nfor (i in 1982:2015) \n{\n  aout <- paste0(\"srv_age_\",i,\".rep\")  \n  lout <- paste0(\"srv_len_\",i,\".rep\")  \n  afile <- paste0(\"data/srv_age_\",i,\".dat\")  \n  lfile <- paste0(\"data/srv_len_\",i,\".dat\")  \n  cfile <- paste0(\"data/srv_sam_\",i,\".dat\")  \n  #adt   <- srvage[yr==i,.(str=1,haul=as.numeric(as.factor(HAULJOIN)),sex=SEX,age=AGE,wt:=ifelse(WEIGHT>0,WEIGHT/1000,(lwa[SEX]*LENGTH^lwb[SEX])/1000),len=LENGTH/10)] \n  # adt   <- srvage[yr==i,.(str=1,haul=as.numeric(as.factor(HAULJOIN)),sex=SEX,age=AGE,wt=wt,len=LENGTH/10)] \n  adt   <- srvage[yr==i,.(str=1,haul=as.numeric(as.factor(HAULJOIN)),sex=SEX,age=AGE,wt = ifelse(is.na(WEIGHT),lwa[SEX]*LENGTH^lwb[SEX]/1000,WEIGHT/1000), len=LENGTH/10  )]\n  ldt   <- srvlen[yr==i,.(1,as.numeric(as.factor(HAULJOIN)),SEX,LENGTH/10,FREQUENCY)] \n  write.table(file=afile,adt ,row.names=FALSE,col.names=FALSE)\n  write.table(file=lfile,ldt ,row.names=FALSE,col.names=FALSE)\n  lad <- dim(adt)[1]\n  lld <- dim(ldt)[1]\n  cat(sep= \" \\n\",\n        paste0(\"srv_\",i) , afile, lfile, lad , lld ,\n        1 , 15 , 20 , 80 , 1,\n        1000000,\n        paste(\"results/Est_srv_\",i,\".dat\",sep=\"\"),\n        file = cfile\n    )\n}\nwadt[,lapply(.SD,mean),yr]\nfor (i in 1982:2015) \n{\n  cfile <- paste0(\"data/srv_sam_\",i,\".dat\")  \n  system(paste0(\"./sam -ind  \",cfile))\n}\n\n#--------------------------\n# Now process survey results in a nice way...\n#--------------------------\n# Read in RACE estimates\nrwadt <- data.table(read.table(paste0(\"results/race_wts.rep\"),header=TRUE) )\nnames(rwadt) <- c(\"yr\",1:15)\nrwadt.m <- melt(rwadt, measure.vars = 2:16, variable.name = \"age\", value.name = \"wt\")\nsetkey(wadt.m,(yr,age))\nsetkey(rwadt.m,(yr,age))\nrwadt.m\nstr(rwadt.m)\n  p <- rwadt.m[age>2&age<11] %>% ggplot(aes(x=as.factor(age),y=wt,fill=as.factor(yr-age))) \n  p <- p + geom_line() + xlab(\"Age\") +  mytheme \n  p <- p + scale_fill_discrete(guide=FALSE) + scale_y_continuous(limits=c(0,1.6),breaks=c(0.5,1.0,1.5))\n  p\n# write files\n# Long to wide\nres <- dcast(wadt.m[,.(mean(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mnsrvwt.dat\")\nres <- dcast(wadt.m[,.(median(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mdnsrvwt.dat\")\nres <- dcast(wadt.m[,.(sd(wt)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"sdsrvwt.dat\")\nres\nrwadt.m\n\n# Survey N at age \ni=1982\nscadt <- data.table(read.table(paste0(\"results/catagesrv_\",i,\".rep\")) )\nnames(scadt) <- c(\"bs\",\"sam\",\"yr\",1:15)\nfor (i in 1983:2015) \n{\n  scadt <- rbind(scadt,data.table(read.table(paste0(\"results/catagesrv_\",i,\".rep\"))) ,use.names=FALSE)\n}\n# wide to long\nscadt.m <- melt(scadt, measure.vars = 4:18, variable.name = \"age\", value.name = \"N\")\nsubstr(scadt.m$yr,5,8) \nscadt.m$age <-as.numeric(scadt.m$age )\nscadt.m$yr <-as.numeric(substr(scadt.m$yr,5,8) )\nscadt.m <- scadt.m[,.(age,N,p=N/sum(N)),.(bs,yr)]\nscadt.m[age %between% c(5,6)&yr==2015] %>% ggplot(aes(x=N,y=N,colour=as.factor(age))) + geom_point()\ndtmp <- as.data.frame(dcast(scadt.m[yr==2015&age %between% c(3,9),.(age,p=N/sum(N)),bs],bs~age,value.var=\"p\"))\n\n ggplot(dtmp,aes(x=\"5\",y=\"6\")) +geom_point()\n pairs(dtmp[,2:8])\n ?pairs\n\n pairs(dtmp[2:8],pch=19,cex=.2, lower.panel = panel.smooth, upper.panel = panel.cor)\n max(dtmp[2:8])\n pairs(dtmp[2:8], panel=panel.smooth, cex=0.5, pch=19, bg = \"light blue\", diag.panel = panel.hist, cex.labels = 2, font.labels = 2,xlim=c(0,.5), ylim=c(0,.5))\n\nnames(dtmp)\n[,.(\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\")]# %>% ggpairs()\nbb(scadt.m)\n\nres <- dcast(scadt.m[,.(mean(N)),.(yr,age),],yr~age,value.var=\"V1\")\nwrite.table(res, file=\"mncatage.dat\")\n",
    "created" : 1502431190948.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2822732498",
    "id" : "1964F5ED",
    "lastKnownWriteTime" : 1471740491,
    "last_content_update" : 1471740491,
    "path" : "~/OneDrive/sampler/cases/ebswp/ebs_survey.R",
    "project_path" : "ebs_survey.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}